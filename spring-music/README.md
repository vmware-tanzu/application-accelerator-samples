# Spring Music

This is a sample application for using database services on [Tanzu Platform](https://tanzu.vmware.com/platform) with the [Spring Framework](https://spring.io) and [Spring Boot](https://projects.spring.io/spring-boot/).

This application has been built to store the same domain objects in one of a variety of different persistence technologies - relational database, document store, and key-value store. This sample, when generated by Tanzu Application Accelerator, allows you to choose the one most applicable to the type of data you need to store..

The application use Spring Java configuration and [bean profiles](http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html) to configure the application and the connection objects needed to use the persistence stores.

## Building

This project requires Java version JAVA_VERSION or later to compile.

To build a runnable Spring Boot jar file, run the following command:

```shell
./gradlew clean assemble
```

## Running the application locally

### Starting the database server

<!--- #IF(#persistenceType == 'jpa') -->
One Spring bean profile should be activated to choose the database provider that the application should use.
The profile is selected by setting the system property `spring.profiles.active` when starting the app.

The supported databases are:

- H2
    - this is an in memory database so it does not need a profile and it gets started during the application startup
- mysql
    - add this profile to the java command when starting the app `-Dspring.profiles.active=mysql`
- postgresql
    - add this profile to the java command when starting the app `-Dspring.profiles.active=postgres`

The application can be started locally using the following configurations and commands.

<!--- #IF(#databaseType == 'h2') -->
#### Using H2 database

Start the application without a profile:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #IF(#databaseType == 'postgres') -->
#### Using PostgreSQL database

First, start a Docker container fpr `postgres`

```shell
docker run --rm --name postgres -p 5432:5432 -e POSTGRES_PASSWORD=password -d postgres
```

Then start the application:

```shell
java -Dspring.profiles.active=postgresql -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #IF(#databaseType == 'mysql') -->
#### Using MySQL database

First, start a Docker container fpr `mysql`

```shell
docker run --rm --name=mysql -p 3306:3306 -d mysql/mysql-server:latest
```

First, we need to capture the generated root password, log in and change it:

```shell
docker logs mysql 2>&1 | grep GENERATED
```

We can now use the password shown above when logging in:

```shell
docker exec -it mysql mysql -uroot -p
```

We should now get a `mysql>` prompt. Run the following command to change the root password:

```sql
ALTER USER 'root'@'localhost' IDENTIFIED BY 'password';
```

Now, we can create a new `spring` user from the same `mysql>` prompt:

```sql
CREATE USER 'spring'@'%' IDENTIFIED BY 'password';
GRANT CREATE, SELECT, INSERT, UPDATE ON mysql.album TO 'spring'@'%';
FLUSH PRIVILEGES;
exit
```

We should now have a `spring` MySQL user that we can use for the app.

Once all of this is done, start the application:

```shell
java -Dspring.profiles.active=mysql -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'redis') -->
Start the redis server using:

```shell
docker run --rm --name redis -p 6379:6379 -d redis
```
The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'mongodb') -->
Start the MongoDB server using:

```shell
docker run --rm --name mongodb -p 27017:27017 -d mongodb/mongodb-community-server:latest
```

The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
Access the application by opening your browser using the URL [http://localhost:8080](http://localhost:8080)

<!--- #IF(#deploymentType == 'tpfork8s') -->
## Tanzu Platform deployment

### Prerequisites

1. Access to [Tanzu Platform](https://docs.vmware.com/en/VMware-Tanzu-Platform/index.html) configured for platform builds.
1. The latest Tanzu CLI and plugins from `vmware-tanzu/app-developer` group installed. Installation instructions can be found in the Tanzu Platform documentation: [Before you begin](https://docs.vmware.com/en/VMware-Tanzu-Platform/SaaS/create-manage-apps-tanzu-platform-k8s/getting-started-deploy-app-to-space.html#before-you-begin-0).
1. You have access to a space for your project and you have used `tanzu login` to authenticate and configure your current Tanzu context and set your project and space using `tanzu project use` and `tanzu space use` respectively.

### About the ContainerApp

Change to the root directory of your generated app.

The project contains a `ContainerApp` manifest file that can be used when building and deploying the app. To review the content of this file run:

```sh
cat .tanzu/config/spring-music.yml
```

### Configure HTTP Ingress Routing

If you want to expose your application with a domain name and route traffic from the domain name to the deployed application, see [Adding HTTP Routing to an Application](https://docs.vmware.com/en/VMware-Tanzu-Platform/SaaS/create-manage-apps-tanzu-platform-k8s/how-to-ingress-to-app.html).

### Build and deploy the app

Change to the root directory of your generated app.

You can build and deploy the app with a single command.
Just run:

```sh
tanzu deploy
```

<!--- #IF(#persistenceType == 'redis') -->
### Check the status of the service bound to the app

The deployment includes a Redis instance using a provided service type.
The instance is bound to the app.

You can list the services created using:

```shell
tanzu services list
```
<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'mongodb') -->
### Check the status of the service bound to the app

The deployment includes a MongoDB instance using a provided service type.
The instance is bound to the app.

You can list the services created using:

```shell
tanzu services list
```
<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'jpa') -->
<!--- #IF(#databaseType == 'h2') -->

You can deploy the application as is when using the embedded `H2` database.
No service binding is necessary.

<!--- #ELSE -->
### Create the service and bind it to the app

<!--- #ENDIF -->
<!--- #IF(#databaseType == 'mysql') -->
The deployment includes a MySQL instance using a provided service type.
The instance is bound to the app.

You can list the services created using:

```shell
tanzu services list
```

<!--- #ENDIF -->
<!--- #IF(#databaseType == 'postgres') -->
The deployment includes a PostgreSQL instance using a provided service type.
The instance is bound to the app.

You can list the services created using:

```shell
tanzu services list
```

<!--- #ENDIF -->
<!--- #ENDIF -->

### Check the status of the app deployment

You can run this command to see the status of the app deployment:

```shell
tanzu apps get spring-music
```

### Use port-forward to access an app instance

You can use the `app port-forward` command to access your app instance's endpoint.
Just select the instance you want when prompted.
Use the following command to start the port-forward:

```shell
tanzu app port-forward spring-music --port 8080
```

Then you can access the app using http://localhost:8080.

<!--- #ENDIF -->