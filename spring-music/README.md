# Spring Music

This is a sample application for using database services on [Tanzu Platform](https://tanzu.vmware.com/platform) with the [Spring Framework](https://spring.io) and [Spring Boot](https://projects.spring.io/spring-boot/).

This application has been built to store the same domain objects in one of a variety of different persistence technologies - relational database, document store, and key-value store. This sample, when generated by Tanzu Application Accelerator, allows you to choose the one most applicable to the type of data you need to store..

The application use Spring Java configuration and [bean profiles](http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html) to configure the application and the connection objects needed to use the persistence stores.

## Building

This project requires Java version JAVA_VERSION or later to compile.

To build a runnable Spring Boot jar file, run the following command:

```shell
./gradlew clean assemble
```

## Running the application locally

### Starting the database server

<!--- #IF(#persistenceType == 'jpa') -->
One Spring bean profile should be activated to choose the database provider that the application should use.
The profile is selected by setting the system property `spring.profiles.active` when starting the app.

The supported databases are:

- H2
    - this is an in memory database so it does not need a profile and it gets started during the application startup
- mysql
    - add this profile to the java command below `-Dspring.profiles.active=mysql`
- postgresql
    - add this profile to the java command below `-Dspring.profiles.active=postgres`

The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

Or, if you want to specify a profile, then use the following command:

```shell
java -Dspring.profiles.active=<database-profile> -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'redis') -->
Start the redis server using:

```shell
docker run --rm --name redis -p 6379:6379 -d redis
```
The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'mongodb') -->
Start the MongoDB server using:

```shell
docker run --rm --name mongodb -p 27017:27017 -d mongodb/mongodb-community-server:latest
```

The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
Access the application by opening your browser using the URL [http://localhost:8080](http://localhost:8080)

<!--- #IF(#deploymentType == 'tpfork8s') -->
## Configuring your Tanzu Platform build environment

### Prerequisites

1. Tanzu CLI and the apps plugin v0.2.0 which are provided as part of [Tanzu Platform](https://docs.vmware.com/en/VMware-Tanzu-Platform/index.html). Installation instructions can be found at [VMware Tanzu Platform Product Documentation - Before you begin](https://docs.vmware.com/en/VMware-Tanzu-Platform/SaaS/create-manage-apps-tanzu-platform-k8s/getting-started-deploy-app-to-space.html#before-you-begin-0).

2. You have access to a space for your project, and you have used `tanzu login` to authenticate and configure your current Tanzu context, and you have set your project and space using `tanzu project use` and `tanzu space use` respectively.

### Configure an image registry to use for building the app

Before you can build your app, you need to specify the registry where the resulting image from the build can be stored.

```sh
tanzu build config --containerapp-registry REGISTRY
```

> Where `REGISTRY` is your container image registry location. For example, `my-registry.io/my-corp-apps/{name}` or `docker.io/<your-docker-id>/{name}` if you use Docker Hub. Note that use of literal `{name}` is required, and it will be replaced with your apps name when you build.

## Configuring your app environment

Change to the root directory of your generated app.

### About the ContainerApp

The project contains a `ContainerApp` manifest file that can be used when building and deploying the app. To review the content of this file run:

```sh
cat .tanzu/config/spring-music.yml
```

### Configure HTTP Ingress Routing

If you want to expose your application with a domain name and route traffic from the domain name to the deployed application, see [Adding HTTP Routing to an Application](https://docs.vmware.com/en/VMware-Tanzu-Platform/SaaS/create-manage-apps-tanzu-platform-k8s/how-to-ingress-to-app.html).


## Deploying the application to Tanzu Platform for Kubernetes

### Build and deploy the app

Change to the root directory of your generated app.

<!--- #IF(#persistenceType == 'jpa') -->
#### Configure service binding for the app

For MySQL and PostgreSQL it is necessary to define the service binding name and type plus setting the active Spring profile.

If you are using MySQL then use:

```shell
tanzu app config servicebinding set music=mysql
tanzu app config non-secret-env set SPRING_PROFILES_ACTIVE=mysql
```

And, if you are using PostgreSQL the use:

```shell
tanzu app config servicebinding set music=postgresql
tanzu app config non-secret-env set SPRING_PROFILES_ACTIVE=postgres
```

<!--- #ENDIF -->
#### Building from local source

You can build using source on your local disk.

To build the app you can run this command:

```sh
tanzu build --output-dir ./prebuilt
```

#### Deploying the app to Tanzu Platform for Kubernetes

Start the app deployment by running:

```sh
tanzu deploy --from-build ./prebuilt
```

#### Building and deploying the app in one step

Instead of building and deploying in separate steps, you can build and deploy the app with a single command.
Just run:

```sh
tanzu deploy
```

### Create the service and bind it to the app

<!--- #IF(#persistenceType == 'redis') -->

You can deploy a Redis instance using a provided service type.
To list available service types use:

```shell
tanzu services type list
```

Then, create the service instance using:

```shell
tanzu services create RedisCluster/music
```

When prompted, bind the service to your deployed app.

You can list the services you have created using:

```shell
tanzu services list
```
<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'mongodb') -->

You can deploy a mongoDB instance using a provided service type.
To list available service types use:

```shell
tanzu services type list
```

Then, create the service instance using:

```shell
tanzu services create MongoDBInstance/music
```

When prompted, bind the service to your deployed app.

You can list the services you have created using:

```shell
tanzu services list
```
<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'jpa') -->

You can deploy the application as is if you want to use the embedded `H2` database.

You can deploy a MySQL or PostgreSQL instance using a provided service type.
To list available service types use:

```shell
tanzu services type list
```

Create a MySQL database service instance using:

```shell
tanzu services create MySQLInstance/music
```

Create a PostgreSQL database service instance using:

```shell
tanzu services create PostgreSQLInstance/music
```

When prompted, bind the service to your deployed app.

You can list the services you have created using:

```shell
tanzu services list
```

<!--- #ENDIF -->

#### Scale the number of instances

When the service you created becomes `Ready`, then you can run this command to scale the app to 1 instance:

```shell
tanzu app scale spring-music --instances=1
```

### Use port-forward to access an app instance

You can use the `app port-forward` command to access your app instance's endpoint.
Just select the instance you want when prompted.
Use the following command to start the port-forward:

```shell
tanzu app port-forward spring-music --port 8080
```

Then you can access the app using http://localhost:8080.

<!--- #ENDIF -->