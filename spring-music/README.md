# Spring Music

This is a sample application for using database services on [Tanzu Platform](https://tanzu.vmware.com/platform) with the [Spring Framework](https://spring.io) and [Spring Boot](https://projects.spring.io/spring-boot/).

This application has been built to store the same domain objects in one of a variety of different persistence technologies - relational database, document store, and key-value store. This sample, when generated by Tanzu Application Accelerator, allows you to choose the one most applicable to the type of data you need to store..

The application use Spring Java configuration and [bean profiles](http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html) to configure the application and the connection objects needed to use the persistence stores.

## Building

This project requires Java version JAVA_VERSION or later to compile.

To build a runnable Spring Boot jar file, run the following command:

```shell
./gradlew clean assemble
```

## Running the application locally

### Starting the database server

<!-- #IF(#persistenceType == 'jpa') -->
One Spring bean profile should be activated to choose the database provider that the application should use.
The profile is selected by setting the system property `spring.profiles.active` when starting the app.

The supported databases are:

- H2
    - this is an in memory database so it does not need a profile and it gets started during the application startup
- mysql
    - add this profile to the java command when starting the app `-Dspring.profiles.active=mysql`
- postgresql
    - add this profile to the java command when starting the app `-Dspring.profiles.active=postgres`

The application can be started locally using the following configurations and commands.

<!-- #IF(#databaseType == 'h2') -->
#### Using H2 database

Start the application without a profile:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!-- #ENDIF -->
<!-- #IF(#databaseType == 'postgres') -->
#### Using PostgreSQL database

First, start a Docker container fpr `postgres`

```shell
docker run --rm --name postgres -p 5432:5432 -e POSTGRES_PASSWORD=changeme -d postgres
```

Then start the application:

```shell
java -Dspring.profiles.active=postgres -jar build/libs/spring-music-1.0.0.jar
```

<!-- #ENDIF -->
<!-- #IF(#databaseType == 'mysql') -->
#### Using MySQL database

First, start a Docker container fpr `mysql`

```shell
docker run --rm --name=mysql -e MYSQL_DATABASE=music -e MYSQL_USER=spring -e MYSQL_PASSWORD=changeme -p 3306:3306 -d mysql/mysql-server:latest
```

Then start the application:

```shell
java -Dspring.profiles.active=mysql -jar build/libs/spring-music-1.0.0.jar
```

<!-- #ENDIF -->
<!-- #ENDIF -->
<!-- #IF(#persistenceType == 'redis') -->
Start the redis server using:

```shell
docker run --rm --name redis -p 6379:6379 -d redis
```
The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!-- #ENDIF -->
<!-- #IF(#persistenceType == 'mongodb') -->
Start the MongoDB server using:

```shell
docker run --rm --name mongodb -p 27017:27017 -d mongodb/mongodb-community-server:latest
```

The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!-- #ENDIF -->
Access the application by opening your browser using the URL [http://localhost:8080](http://localhost:8080)

## Tanzu Platform deployment

### Prerequisites

You need to be logged in to Tanzu Platform for Cloud Foundry and have set the target org and space.

### Build the app

To compile the application code and create a runnable jar file, use the following command:

```sh
./gradlew build
```

### Create a service instance

We will take advantage of service available in the marketplace.
To review what services are available, run the following command:

```sh
cf marketplace
```

Based on the offerings and plans available, you might have to adjust the command below.

<!-- #IF(#persistenceType == 'jpa') -->
<!-- #IF(#databaseType == 'h2') -->
#### Using H2 database

The H2 database is an in memory database so there is no need to create a service.

<!-- #ENDIF -->
<!-- #IF(#databaseType == 'postgres') -->
#### Using PostgreSQL database

To create a PostgreSQL service, run the following command:

```sh
cf create-service postgres db-small music
```
<!-- #ENDIF -->
<!-- #IF(#databaseType == 'mysql') -->
#### Using MySQL database

To create a MySQL service, run the following command:

```sh
cf create-service p.mysql db-small music
```
<!-- #ENDIF -->
<!-- #ENDIF -->
<!-- #IF(#persistenceType == 'redis') -->
#### Using Redis

To create a Redis service, run the following command:

```sh
cf create-service p.redis on-demand-cache music
```
<!-- #ENDIF -->
<!-- #IF(#persistenceType == 'mongodb') -->
#### Using MongoDB

To create a MongoDB service, run the following command:

```sh
cf create-service mongodb default music
```
<!-- #ENDIF -->

### Push the app

To push the app to your space, run this command:

```sh
cf push
```

This will deploy the app based on the settings in the `manifest.yml` file, including binding to a service named `music` if applicable.

### Access the app

Find the route assigned to the app using this command:

```sh
cf app spring-music
```

The route assigned will be listed under `routes:`.

### Delete the app

To delete the app and remove the assigned route, run the following command:

```sh
cf delete spring-music -r
```
<!-- #IF(!(#persistenceType == 'jpa' && #databaseType == 'h2')) -->

To delete the service, run this command:

```sh
cf delete-service music
```
<!-- #ENDIF -->
