engine:
  chain:
    - condition: "#bsGitRepository != null"
      chain:
      - includes: [ "**/workload.yaml" ]
        let:
          - name: repoUrl
            expression: "T(org.springframework.web.util.UriComponentsBuilder).fromUriString('https://' + #bsGitRepository).build(true)"
        chain:
          - type: OpenRewriteRecipe
            recipe: org.openrewrite.yaml.ChangeValue
            options:
              oldKeyPath: '"$.spec.source.git.url"'
              value: "#repoUrl.scheme + '://' + #repoUrl.host + '/' + #repoUrl.queryParams['owner'][0] + '/' + #repoUrl.queryParams['repo'][0]"
          - type: OpenRewriteRecipe
            recipe: org.openrewrite.yaml.ChangeValue
            options:
              oldKeyPath: '"$.spec.source.git.ref.branch"'
              value: "#bsGitBranch"
          - type: OpenRewriteRecipe
            recipe: org.openrewrite.yaml.DeleteKey
            options:
              keyPath: "'$.spec.source.subPath'" # subPath is not supported atm

    - condition: "#bsGitRepository == null"
      type: Exclude
      patterns: [ "**" ]
